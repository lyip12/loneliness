demographicschorovis() // for avoiding naming issue

var choronarratives = {
    Austria: "Austria is commonly known as one of the safest and most beautiful countries in Europe. By international standards, It has a very generous welfare state, and was known as one of the happiest European nations. Yet, despite living in a country with a high quality of life, a relatively thriving economy and a stable political system only one in five Austrians say they are truly happy, according to a two year study from Vienna’s Modul University. Austrians believe financial worries, physical pain, loneliness, stress, and frustration about work all contribute to a reduced sense of well-being. The main cause to people’s loneliness and social isolation was specific regional differences in living areas.",
    Belgium: "Research led by Ghent University has shown that no less than 46 percent of the Belgians feels lonely, either permanently or at times. Adults aged between 20 and 50 are particularly vulnerable. The crucial factor is a relationship, and living without a partner, multiplies the risk of becoming lonely. Other factors triggering loneliness in Belgium are low income and a bad health.",
    "Czech Rep.": "The problem of loneliness in Czech Republic surrounds the younger population, where it is a common issue in adolescence and has been linked to various negative outcomes. Inconsistent parenting, shyness, and peer victimisation were associated with higher odds for loneliness by research conducted by Universities in the nation. ",
    Denmark: "About one in 10 young people in Denmark report that they are lonely. While this may seem surprising in a country that is frequently rated one of the happiest in the world, it mirrors data from around the world showing a spike in loneliness among the young as well as the old. It is estimated that 35,000 people in Denmark feel that they are severely lonely, and the problem is particularly prevalent among people aged 16-29 and people over the age of 85. Studies show that loneliness increases the chance of high blood pressure, insomnia and depression, and long-term loneliness costs Danish society an estimated 8 billion kroner every year.",
    England: "Great Britain (UK/England) is the second loneliest country in the world with an incredible amount of population living in single person households. One contributing factor is that Britain has a stable welfare system and that system rewards those who are poor or on unemployment compensation who live alone with an increase in benefits. Due to this, more individuals are choosing a solitary life in order to reap more benefits causing a noticable rise in the number of lonely people, and a steady decline in the length of long-lasting marriages.",
    Estonia: "Lonelines and social exclusion is a common issue among elderlies in Estonia. The cause is often poor health and apathy regarding the elderly that have worked hard during the soviet era and now have little savings, real estate or living relatives. It is understood as a situation in which one is unable to fully participate in social life due to insufficient education, low income, poverty, material deprivation, unemployment or poor health, and his/her access to resources and services is limited. Social exclusion entails negative consequences not only for the excluded individual but for the society as a whole, since the individual’s potential contribution to the society diminishes. In addition, Estonia non-citizens are more at risk of social exclusion compared to Estonian citizens.",
    Finland: "The latest figures on income and living conditions published by Statistics Finland show that 890,000 persons (16.4% of the household population) were at risk of poverty or social exclusion. And 950,000 Finns aged 16 or older (21.2%) suffer loneliness. Most of the people that are at risk of poverty or social exclusion live in low income households. Being at risk of poverty or social exclusion means that the person is living in a low income household, a household with low work intensity or a household that experiences severe material deprivation.",
    France: "A growing number of French people, including the younger generations, are afflicted by loneliness. Poor job security, decreasing salaries and the loss of traditional family networks are blamed for the rise. French culture is known for the importance it places on family life, but numerous national surveys show that a loss of family networks due to rapid employment status change has led to almost 40 percent of French people to not engage in regular contact with their families.",
    Germany: "A majority of Germans think that loneliness is a big problem in their society, with only a small number seeing it as of little relevance. A survey carried out by the federal government in May found that from 2011 to 2017, the number of Germans between the ages of 45 and 84 who reported that they sometimes felt very lonely jumped by 15%. In some age groups, that number jumped by 59%, and one in four teenagers reported at least occasional feelings of lonesomeness.",
    Hungary: "The number of elderly people living on their own is expected to increase as a consequence of the demographic change in Hungary. Loneliness may become a huge health problem in the nation – elderly individuals are particularly vulnerable to it. From a study in 2017, the risk of loneliness varies according to the elderly individual’s level of wealth. The least wealthy in society experience the greatest risk of loneliness. Also, loneliness is higher among women. 28 % of the least wealthy women report loneliness, compared to 18 % of the wealthiest.",
    Ireland: "A growing epidemic, loneliness affects almost one in 10 people in Ireland. It has also been identified as a key health hazard. Loneliness is a subjective realisation that quality and/or quantity of one’s social networks isn’t sufficient to meet one’s needs. One-third of Irish adults over 50 report feeling lonely at least some of the time. Loneliness is most prevalent among over-75s and those living alone.",
    Israel: "Israel's loneliness is on the national level. Its international position has declined in recent years, and there have been frictions that are not likely to disappear in the years to come. Its relations with other states are either highly problematic or have not improved despite the Israeli government’s efforts. It is Israel’s policy in the Occupied Territories that is being increasingly criticised and this is creating a sort of ‘vicious circle’ in Israel: the critiques reinforce Israeli’s ‘bunker mentality’, strengthening the ethno-nationalist character of Israeli politics and society and causing de-democratisation, and this, in turn, brings on more international isolation. The country itself is lonelier than its people.",
    Lithuania: "A lot of lonely old people live in Lithuania. They are struggling to maintain human dignity in the autumn of life. This is not always successful, because their days are accompanied by poverty, illness, loneliness, and despair. Typically, certain social groups are more sensitive to socio-economic challenges and risks and have less resources to cope with successfully. Statistics show that the most vulnerable persons are children, disabled people, old-age pensioners, single people and the unemployed. Based on existing data, poverty and social exclusion rates in Lithuania are among the highest the EU.",
    Netherlands: "More than a million people in the Netherlands feel very lonely. A third of Dutch feel moderately lonely. There are specific groups in the Dutch soceity that experience loneliness more often. Almost 60 percent of divorced people and widows or widowers feel lonely. Extreme loneliness is more common among divorced people, 20 percent, than widows and widowers, 16 percent. Loneliness is also more common among the oldest people in the population - people over the age of 75. This population group suffers from all sorts of circumstances that contribute to loneliness, such as a partner's death or physical or mental limitations.",
    Norway: "Nordic countries like Norway may regularly come out on top of world happiness indexes for wellbeing year-on-year - but new research shows the happiness is far from universal and loneliness is quite common. Norway saw a 40% increase over the five-year-period of young people seeking help for mental health difficulties. The country's high incomes protected people against feeling they were suffering or struggling, but research also found that people were more than three times more likely to report extremely low mental health if they were unemployed due to the large differences between different class's income.",
    Poland: "Loneliness and depression are prevalent among Polish university students and may contribute to poor academic achievements or higher probability of dropping out of university. Based on their less favorable social status as well as stressful lives, a relatively high proportions of students and young adults in the central and southern European countries of Poland consider themselves lonely.",
    Portugal: "In Portugal, age and marital status were significant predictors of loneliness, and loneliness increased with age. Divorced or windowed participants reported higher loneliness than single or married people, although gender did not significantly contribute to loneliness.",
    Spain: "",
    Sweden: "",
    Switzerland: "",
    Slovenia: ""
};
//console.log(choronarratives["France"]);

function demographicschorovis(){
    var selector = "Lonely_Frequent";
    var toggle;
    //responsive layout from https://stackoverflow.com/questions/16265123/resize-svg-when-window-is-resized-in-d3-js
    var svg = d3.select("#yipchoro")
    .classed("yipsvg-container", true)
    .append("svg")
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "0 0 300 400")
    .classed("svg-content-responsive", true);

    var lucypath = d3.geoPath();
    var projection = d3.geoMercator()
    .scale(230)
    .center([0, 0])
    .translate([130, 410]);

    var data = d3.map();

    updateChoropleth(selector)

    $("#yipchorofilter").click(function(){
        Tooltip.style("opacity", 0);
        toggle =1;
        var selector = $("input[name='choro']:hover").val();
        //console.log(yipchoroselector);
        if(selector!== undefined && selector!== "NA"){updateChoropleth(selector)};
    });


    var Tooltip = d3.select("#yipchoro")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "#161c26")
    .style("border-radius", "3px")
    .style("padding", "10px")

    //actual chorovis starts
    function updateChoropleth(selector) {


        //var selector2 = d3.select("#yipstats").property("value2");

        if(selector == "One_Person_Household_Frequent"){ var cate = "one person household"; } else if(selector == "Mutiple_People_Household_Frequent"){ var cate = "multiple people household"; } else if(selector == "Conflict_Never_Frequent"){ var cate = "no conflict household"; } else if(selector == "Conflict_Sometimes_Frequent"){ var cate = "sometimes conflict household"; } else if(selector == "Conflict_Often_Frequent"){ var cate = "often conflicting household"; } else if(selector == "No_Confidant_Frequent"){ var cate = "no confidant"; } else if(selector == "At_Least_One_Confidant_Frequent"){ var cate = "more than one confidant"; } else if(selector == "Native_Frequent"){ var cate = "native (local)"; } else if(selector == "Immigrant_Frequent"){ var cate = "immigrant"; } else if(selector == "Ethnic_Minority_Frequent"){ var cate = "ethinic minority"; } else if(selector == "Ethnic_Majority_Frequent"){ var cate = "ethnic majority"; } else if(selector == "Religious_Frequent"){ var cate = "religious"; } else if(selector == "Non_Religious_Frequent"){ var cate = "non-religious"; } else if(selector == "Big_City_Frequent"){ var cate = "big city"; } else if(selector == "Suburb_Frequent"){ var cate = "suburb"; } else if(selector == "Small_City_Frequent"){ var cate = "small city"; } else if(selector == "Countryside_Frequent"){ var cate = "countryside"; } else if(selector == "Unemployed_Past_Year_Frequent"){ var cate = "past year unemployed"; } else if(selector == "Unemployed_Past_Month_Frequent"){ var cate = "past month unemployed"; } else if(selector == "Unemployed_Past_Days_Frequent"){ var cate = "past days unemployed"; } else if(selector == "Employed_Frequent"){ var cate = "employed"; } else if(selector == "Income_Comfortable_Frequent"){ var cate = "comfortable income"; } else if(selector == "Income_Coping_Frequent"){ var cate = "coping income"; } else if(selector == "Income_Difficult_Frequent"){ var cate = "difficult income"; } else if(selector == "Income_Very_Difficult_Frequent"){ var cate = "very difficult income"; } else { var cate = "all"; };

        a = [];
        //console.log(selector2);
        d3.queue()
            .defer(d3.json, "data/worldeu.geojson")
            .defer(d3.csv, "data/ESS_Demographic.csv", function (d) {
            data.set(d.Code, +d[selector]);
            a.push(+d[selector]);
        })
            .await(ready);


        function ready(error, topo, loneliness) {

            let yipmouseOver = function(d) {
                if(toggle !== 0 && d.data !== "no data"){
                    d3.selectAll(".Country")
                        .transition()
                        .duration(100)
                        .style("opacity", .1)
                    d3.select(this)
                        .transition()
                        .duration(100)
                        .style("opacity", 1)
                    //console.log("tis is working")
                        .attr('cursor', 'pointer');

                    tip = "in " + d.properties.name + ", around <em>" + d.data + "%</em> of <em>" + cate + " population </em>is frequently lonely.<br><b>click for more information.</b>";

                    Tooltip
                        .html(tip)
                        .style("left", (d3.mouse(this)[0]*2) + "px")
                        .style("top", (d3.mouse(this)[1]*2.7-80) + "px")
                        .transition()
                        .duration(300)
                        .style("opacity", 1);

                    //var yipchoroselector = d.properties.name;
                    //yipsmallmultiples(yipchoroselector);

                    //console.log(d3.mouse(this)[0]/window.innerWidth*300);
                }
            }

            let yipmouseLeave = function(d) {
                if(toggle !== 0 && d.data !== "no data"){
                    d3.selectAll(".Country")
                        .transition()
                        .duration(100)
                        .style("opacity", 1)
                    d3.select(this)
                        .transition()
                        .duration(100)

                    Tooltip
                        .style("opacity", 0)

                }
            }

            let yipmouseClick = function (d) {
                if(toggle == 0) {
                    d3.selectAll(".Country")
                        .transition()
                        .duration(300)
                        .style("opacity", 1)
                    d3.select(this)
                        .transition()
                        .duration(300)

                    //var yipchoroselector = "All";
                    //yipsmallmultiples(yipchoroselector);

                    toggle =1;

                } else {  
                    if(d.data !== "no data"){
                        d3.selectAll(".Country")
                            .transition()
                            .duration(300)
                            .style("opacity", .02)
                        d3.select(this)
                            .transition()
                            .duration(800)
                            .style("opacity", 1)
                        toggle = 0;

                        tip = choronarratives[d.properties.name]+"<br><b>click again to exit.</b>";

                        Tooltip
                            .html(tip)
                            .style("left", (d3.mouse(this)[0]*2) + "px")
                            .style("top", (d3.mouse(this)[1]*2.7-80) + "px")
                            .transition()
                            .duration(300)
                            .style("opacity", 1);
                    }
                }
            }

            var k = (d3.max(a) - d3.min(a))/9;
            var legend = []
            for(var i = 0; i<9;i++){
                legend.push(d3.min(a)+k*i);
            };

            console.log(legend)
            var fill = d3.scaleThreshold()
            .domain(legend)
            .range(d3.schemeBlues[9]);

            d3.selectAll(".yipchorotext")
                .attr("opacity", 1)
                .transition()
                .duration(800)
                .attr("opacity", 0)
                .remove()

            for(var i = 0; i<9;i++){

                if(i==0){  
                    svg.append("text")
                        .attr("class","yipchorotext")
                        .attr("x", 90)
                        .attr("y", 78)
                        .attr("font-family", "'Roboto', sans-serif")
                        .attr("font-size", "4px")
                        .attr("fill", "#8293b6")
                        .text("0.00%");
                    
                    svg.append("text")
                        .attr("class","yipchorotext")
                        .attr("x", 80)
                        .attr("y", 3)
                        .attr("font-family", "'Roboto', sans-serif")
                        .attr("font-size", "4px")
                        .attr("fill", "#8293b6")
                        .text("percentage population frequently lonely");
                }

                svg.append("rect")
                    .attr("x", 80)
                    .attr("y", 69-i*7)
                    .attr("width", 7)
                    .attr("height", 7)
                    .transition()
                    .duration(800)
                    .attr("fill", function(d){
                    return fill(d3.min(a)+k*i);
                }); 

                var num = d3.min(a)+(k*(i+1));
                var n = num.toFixed(2);

                svg.append("rect")
                    .attr("x", 80)
                    .attr("y", 69-i*7)
                    .attr("width", 7)
                    .attr("height", 7)
                    .style("stroke", "black")
                    .style("stroke-width", 0.05)
                    .transition()
                    .duration(800)
                    .attr("fill", function(d){
                    return fill(d3.max(a)-(d3.min(a)+k*i));
                }); 

                svg.append("text")
                    .attr("x", 90)
                    .attr("class","yipchorotext")
                    .attr("y", 71-i*7)
                    .attr("font-family", "'Roboto', sans-serif")
                    .attr("font-size", "4px")
                    .attr("fill", "#8293b6")
                    .text(n + "%")
                    .attr("opacity", 0)
                    .transition()
                    .duration(800)
                    .attr("opacity", 1);

            }

            d3.selectAll(".lucypath2")
                .transition()
                .duration(800)
                .remove();

            // Draw the map
            svg.append("g")
                .selectAll(".lucypath2")
                .data(topo.features)
                .enter()
                .append("path")
                .attr("class","lucypath2 Country")
                .attr("d", d3.geoPath().projection(projection))
                .style("stroke", "#8293b6")
                .style("stroke-width", 0.05)
                .style("opacity", 0)
                .transition()
                .duration(800)
                .attr("fill", function (d) {
                d.data = data.get(d.properties.adm0_a3) || "no data";
                if(d.data !== "no data"){
                    return fill(d3.max(a)-d.data);
                };
            })
                .style("opacity", 1);


            d3.selectAll(".lucypath2")
                .on("click", yipmouseClick)
                .on("mouseover", yipmouseOver)
                .on("mouseleave", yipmouseLeave)


        }
    }
};